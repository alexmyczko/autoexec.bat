#!/bin/bash

# small CPU/MEM/DSK/NET benchmark for linux/macos
# alex@aiei.ch

# check if called binaries are available
for a in date memtester bc dd sync printf speedtest-cli; do
    which $a >/dev/null
    if [ ! $? -eq 0 ]; then
	echo $a not found
	exit 1
    fi
done

d=date
which gdate >/dev/null && d=$(which gdate)

# MEMORY 16 MB
echo -n "MEM "
start=$($d +%s.%N)
memtester 16M 1 &>/dev/null
end=$($d +%s.%N)
printf "[%.2f\"]\n" $(echo $end - $start | bc)

# CPU, single core, (3000 digits of pi)
echo -n "CPU "
start=$($d +%s.%N)
/bin/echo "scale=3000;4*a(1)" | bc -l &>/dev/null
end=$($d +%s.%N)
printf "[%.2f\"]\n" $(echo $end - $start | bc)

# DISK 6.4 GB
echo -n "DSK "
start=$($d +%s.%N)
l=$(pwd)
dd=M
if [ $(uname) = Darwin ]; then dd=m; fi
if [ -d /scratch ]; then l=/scratch; fi
# check if there's enough diskspace, compare value above with num
freemb=`df -m $l | tail -1 | awk '{print $4}'`
if [ 6400 -gt $freemb ]; then
    echo 6.4 GB diskspace needed, but only $freemb MB found.
    exit 1
fi
sync;dd if=/dev/zero of=$l/_benchmark bs=64${dd} count=100 &>/dev/null;rm $l/_benchmark;sync
end=$($d +%s.%N)
printf "[%.2f\"]\n" $(echo $end - $start | bc)

# NETWORK
echo -n "NET "
start=$($d +%s.%N)
s=$(speedtest-cli --bytes --simple | tail -2) 
end=$($d +%s.%N)
printf "[%.2f\"] %s\n" $(echo $end - $start | bc) "$(echo $s)"
